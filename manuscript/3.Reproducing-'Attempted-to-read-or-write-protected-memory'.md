## Reproducing the 'Attempted to read or write protected memory' issue

I used to get this error when trying to connect to a java process like ZAP:

![image](images/image_thumb_25255B3_25255D1.png)

Which we can inject O2 into

![image](images/image_thumb_25255B4_25255D1.png)

When executing the **PoC - Jni4Net - List JavaProperties.h2** process, I get an unmanaged error (which is always a worse case scenario in the .NET Interop world)

![image](images/image_thumb_25255B6_25255D1.png)

As the (simpler script shows), the error happens on the  **CreateJVM** invocation

![image](images/image_thumb_25255B7_25255D1.png)

My next step was to create a local build of Jni4Net (which you saw on the preview note) and to use it to attach into an existing running ZAP with an O2 REPL injected.

Here is the moment when I have VisualStudio hooked, the script compiled (in the ZAP REPL), the jni4net dll loaded (with Symbols) in VisualStudio and a breakpoint on the CreateJVM method:

![image](images/image_thumb_25255B60_25255D.png)

Here is where I think the problem exists:

![image](images/image_thumb_25255B62_25255D.png)

the args object (created via JNI) seems to be empty.

It is then assigned to the value of the Jni4Net class path string

![image](images/image_thumb_25255B63_25255D.png)

The args object is used here:

![image](images/image_thumb_25255B64_25255D.png)

And inside that method, if I let **args** to be used, we will get the **'Attempted to read or write protected memory'** error

![image](images/image_thumb_25255B66_25255D.png)

but, if I change the execution path (manually) and set it to the line below (where no args is passed)

![image](images/image_thumb_25255B67_25255D.png)

Then the execution will be ok (note that the path with the &initArgs would had thrown an **'Attempted to read or write protected memory'**  by now):

![image](images/image_thumb_25255B68_25255D.png)

The only problem with this approach (which is basically not adding the classpath clue to the current JVM) is that unless we manually add the jni4net jar to the target app, we will get an exception here:

![image](images/image_thumb_25255B69_25255D.png)

i.e. br.handle would be 0 (meaning that the **net.sf.jnin4net.Bridge** class could not be found)
